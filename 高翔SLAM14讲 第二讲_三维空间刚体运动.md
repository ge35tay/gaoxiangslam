# 三维刚体运动

刚体在三维空间中的运动： 旋转 + 平移

## 1. 旋转矩阵

### 1.1 点，向量和坐标系

我们需要考虑的是相机的 **位姿**，即位置(由三个坐标来指定)与姿态(相机的朝向)

- 向量： 由点与点组成的， 具有大小和方向的量， 点的坐标由从原点出发指向他的向量表示

- 确定一个坐标系，即一个线性空间的基 $ (e_1, e_2, e_3) $ ,则向量在这组基底下的坐标为
  $$
  a = [e_1, e_2, e_3][a_1, a_2, a_3]^T = a_1e_1 + a_2e_2 + a_3e_3
  $$
  

向量的内积: 
$$
ab = a^Tb= |a||b|cos<a,b>
$$
向量的外积:
$$
a × b = \left| \begin{array}{cccc} i  &  j   & k \\ a_1  &  a_2   & a_3\\ b_1  &  b_2   & b_3 \end{array} \right| = \left[ \begin{array}{c} a_2b_3 - a_3b_2 \\ a_3b_1 - a_1b_3\\ a_1b_2 - a_2b_1 \end{array} \right] 
= \left[ \begin{array}{cccc} 0  &  -a_3   & a_2 \\ a_3  &  0   & -a_1\\ -a_2  &  a_1   & 0 \end{array} \right]b = a\^b
$$
外积的方向垂直于两个向量，大小为$ |a||b|sin<a, b>$ ;     **^符号**: 反对称矩阵

外积也可以表示向量的旋转



### 1.2 坐标系间的欧式变换

在机器人的运动过程中，我们常设定一个 **惯性坐标系（或世界坐标系）$x_w, y_w, z_w$** 通常认为是静止不动的，

而机器人是一个**移动坐标系 $x_c, y_c, z_c$** , 假设相机视野中某个向量 $p$ , 他的坐标为 $p_c$， 而在世界坐标下，他的坐标 $p_w$, 我们常用坐标系间变换矩阵 $T$来描述这两个坐标之间的变换

![image-20220427082530875](C:\Users\24527\AppData\Roaming\Typora\typora-user-images\image-20220427082530875.png)



* **欧式变换**：相机运动你是一个刚体运动，它保证了同一个向量在各个坐标系下长度和夹角不会发生变化

​		这样一个欧式变换由一次旋转和一个平移两部分组成

  - 首先是旋转， 设某个单位正交基 $(e_1, e_2, e_3)$ 经过了一次旋转,变成 $(e'_1, e'_2, e'_3)$。 则对于同一个向量 $a$      **(该向量没有随坐标系旋转而运动)** , 根据坐标定义他在两个坐标系底下的坐标$[a_1, a_2, a_3]$ 和 $[a'_1, a'_2, a'_3]$ 有：
    $$
    [e_1, e_2, e_3]\left[ \begin{array}{c} a_1 \\ a_2\\ a_3 \end{array} \right] 
    = [e'_1, e'_2, e'_3]\left[ \begin{array}{c} a'_1 \\ a'_2\\ a'_3 \end{array} \right]
    $$
    同时左乘 $\left[ \begin{array}{c} e_1^T \\ e_2^T\\ e_3^T \end{array} \right] $, 则左边有单位矩阵:
    $$
    \left[ \begin{array}{c} a_1 \\ a_2\\ a_3 \end{array} \right] 
    = \left[ \begin{array}{cccc} e_1^Te'_1  &  e_1^Te'_2   & e_1^Te'_3 \\ e_2^Te'_1  &  e_2^Te'_2   & e_2^Te'_3\\ e_3^Te'_1  &  e_3^Te'_2   & e_3^Te'_3 \end{array} \right]\left[ \begin{array}{c} a'_1 \\ a'_2\\ a'_3 \end{array} \right] = Ra'
    $$
    **旋转矩阵R** 由两组基之间的内积组成， 刻画了旋转前后同一个向量的坐标变换关系。 

    旋转矩阵R是一个 **行列式为1的正交矩阵** ( $ R^T = R^{-1}$) .反之行列式为1的旋转矩阵也是一个正交矩阵

    ∴ 旋转矩阵的集合为：
    $$
    SO(n) = \{R \in R^{n×n} | RR^T = I, det(R) = 1 \}
    $$
    SO(n)特殊正交群(special orthogonal group), **旋转矩阵也可以描述相机的旋转**



​		∴  $ a' = R^{-1} a = R^Ta$ ,  $R^T$ 刻画了一个相反的旋转。

​		欧式变换的旋转平移：$ a' = Ra + t$



### 1.3 变换矩阵与齐次坐标

上述的欧式变换表示的旋转平移不是一个线性关系，在多次变换后会过于复杂，因此引入齐次坐标并重写欧式变换的旋转平移
$$
\left[ \begin{array}{c} a'\\ 1 \end{array} \right] = \left[ \begin{array}{c} R & t \\ 0^T & 1 \end{array} \right] \left[ \begin{array}{c} a\\ 1 \end{array} \right] = T \left[ \begin{array}{c} a\\ 1 \end{array} \right]
$$
我们在三维向量的末尾添加1，变成了四维向量，称为 **齐次坐标** . 在这个四维坐标中我们可以把旋转和平移写在一个矩阵中。该矩阵T称为变换矩阵 (Transform matrix)



> Homogeneous Coordinate:
>
> http://www.songho.ca/math/homogeneous/homogeneous.html

在齐次坐标中，某个点的坐标的每个分量同乘一个非零常量k表示的仍是欧式空间的同一个点，这一个性质可以很好的用于投影几何中描述平行线在投影面上相交的性质。

对于齐次坐标下的变换矩阵T，其归于特殊欧式群：
$$
SE(3) = \{T =  \left[ \begin{array}{c} R & t \\ 0^T & 1 \end{array} \right] \in R ^ {4×4} | R \in SO(3), t \in R^3\}
$$
T的逆矩阵（反向变换）
$$
T^{-1} =  \left[ \begin{array}{c} R^T & -R^Tt \\ 0^T & 1 \end{array} \right]
$$

## 2. 旋转向量和欧拉角

### 2.1 旋转向量

矩阵表示 translation 的缺点：

- SO(3) 的旋转矩阵有9个量，但一次旋转只有三个自由度， 因此这种表达方式是冗余的。 而变换矩阵用十六个量表达了六自由度的变换， 我们希望有更紧凑的表达方式
- 旋转矩阵自身带有约束，他必须是个正交矩阵，且行列式为1，变换矩阵的R分量也是如此，当我们想要估计或优化一个旋转矩阵或变化矩阵时，这些约束会让求解更加困难。



任何一个旋转都可以用一个旋转轴和一个旋转角来刻画，因此我们可以用一个向量，其方向与旋转轴相同，长度与旋转角相同， 这个向量称之为 **旋转向量** 

从旋转向量到旋转矩阵的过程: **罗德里格斯公式**

![image-20220427163817224](C:\Users\24527\AppData\Roaming\Typora\typora-user-images\image-20220427163817224.png)!(C:\Users\24527\AppData\Roaming\Typora\typora-user-images\image-20220427163825103.png)

![image-20220427163904618](C:\Users\24527\AppData\Roaming\Typora\typora-user-images\image-20220427163904618.png)

![image-20220427164001462](C:\Users\24527\AppData\Roaming\Typora\typora-user-images\image-20220427164001462.png)



从一个旋转矩阵到旋转向量:
$$
tr(R) = cos\theta tr(I) + (1 - cos \theta)tr(nn^T) + sin \theta tr(n\^)
$$

$$
 = 3cos\theta + 1 - cos \theta = 1 + 2cos\theta
$$

所以：
$$
\theta = arccos((tr(R)-1)/2)
$$

> 在机器学习里，主要为了获取数据的特征值，那么就是说，在任何一个矩阵计算出来之后，都可以简单化，只要获取矩阵的迹，就可以表示这一块数据的最重要的特征了，这样就可以把很多无关紧要的数据删除掉，达到简化数据，提高处理速度。

### 2.2 欧拉角

欧拉角提供了一个非常直观的方式来描述旋转， 它使用了三个分离的转角，把一个旋转分解成三次绕不同轴的旋转

如经典的ZYX轴旋转（偏航-俯仰-滚转）偏航:绕z轴， 俯仰:绕y轴， 滚转: 绕x轴



欧拉角的问题： 万向锁问题：在俯仰角为 90°或-90°时，第一次和第三次旋转会使用同一个轴，使得系统丢失一个自由度，因为他都可以用z轴来表示。 ===》奇异性问题

### 2.3 四元数

旋转矩阵是用九个量描述3个自由度的旋转，具有冗余性；欧拉角和旋转向量是紧凑的，但是具有奇异性。 事实上不存在不带奇异性的三维向量描述方式， 因此由复数启发（**用复数集表示复平面上的向量，而复数的乘法可以表达复平面上的旋转**， 例如乘上复数 $i$ 相当于逆时针把一个复向量旋转90° ），提出四元数



四元数$q$ 拥有一个实部和三个虚部：
$$
q = q_0 + q_1i + q_2j + q_3k
$$
i, j, k分别为三维虚坐标。 而实部 = 0， 表示4维投影到三维时正好落在单位球面上， =1 表示在投影在原点，0-1投影在单位圆内， 负数表示在球面外。

- 四元数的虚部i, j, k 满足关系式:
  $$
  i^2 = j^2 = k^2 = -1 \\
  ij = k, ji=-k\\
  jk = i, kj=-i\\
  ki = j, ik=-j
  $$

- 四元数也可以表示为一个标量和一个向量
  $$
  q = [s, v], s = q_0 \in R, v= [q_1, q_2, q_3]^T \in R^3
  $$

- 如果一个四元数的虚部为0，则称为实四元数，反之如果他的实部为0则称为虚四元数

- 用四元数表达旋转： 表达旋转需要满足的条件： 旋转后向量的模长不发生变化。 

  ![image-20220427212243179](C:\Users\24527\AppData\Roaming\Typora\typora-user-images\image-20220427212243179.png)

  

  

  对于四元数的性质， 乘以$i$ 对应着旋转180°，这样才能满足 ij=k这类四元素虚数坐标表达式, $i^2=-1$ 表示一个向量绕$i$轴旋转360度后得到了一个相反的向量，需要绕两周才能与其原来的样子相等，因此任意的旋转都可以由两个互为相反数的四元数表示

- 假设某个旋转是绕单位向量 $n = [n_x, n_y, n_z]^T$ 进行了角度为 $\theta$ 的旋转，则该旋转的四元数形式为:
  $$
  q = [cos(\theta /2), n_xsin(\theta /2), n_ysin(\theta /2), n_zsin(\theta /2)]^T
  $$
  从该单位四元数中我们可以计算出旋转轴与夹角:
  $$
  \theta = 2 arccosq_0 \\
  [n_x, n_y, n_z]^T = [q_1, q_2, q_3]^T/sin(\theta/2))
  $$



​		取 $\theta$ 为0，则得到一个没有任何旋转的实四元数:
$$
q_0 = [\pm 1, 0, 0, 0]^T
$$

### 2.4 四元数的运算

现有两个四元$q_a, q_b$, 他们的向量表示为 $[s_a, v_a], [s_b, v_b]$， 即：
$$
q_a = s_a + x_ai+y_aj+z_ak,   q_b = s_b + x_bi+y_bj+z_bk
$$

- 加减法:
  $$
  q_a \pm q_b = [s_a \pm s_b, v_a \pm v_b]
  $$

- 乘法
  $$
  q_aq_b = s_as_b - x_ax_b - y_ay_b - z_az_b \\ + (s_ax_b + y_az_b + x_as_b - z_ay_b)i \\ +(s_ay_b + z_ax_b + s_by_a - y_ay_b)j \\ + (s_az_b + x_ay_b + z_as_b - z_az_b)k
  $$
  或者可以表示为:
  $$
  q_aq_b = [s_as_b - v_a^Tv_b, s_av_b + s_bv_a + v_a×v_b]
  $$
  所以: 四元数乘法一般是不可交换的，除非$v_a, v_b$在$R^3$ 中共线

- 共轭， 把虚数取成相反数
  $$
  q_a^* = s_a - x_ai - y_aj - z_ak = [s_a, -v_a]
  $$

  $$
  q*q = [s_a^2 + v^Tv, 0]
  $$

- 模长
  $$
  ||q_a|| = \sqrt{s_a^2 + x_a^2 + y_a^2 + z_a^2}
  $$

  $$
  ||q_aq_b|| = ||q_a||||q_b||
  $$

- 逆

  一个四元数的逆为：
  $$
  q^{-1} = q^*/||q||^2
  $$
  ∴ 四元数和自己逆的乘积为实四元数的1

- 
